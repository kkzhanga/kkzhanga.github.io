<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>KKZhang’s Blog</title>
  
  
  <link href="https://kkzhanga.github.io/atom.xml" rel="self"/>
  
  <link href="https://kkzhanga.github.io/"/>
  <updated>2020-12-14T12:18:20.871Z</updated>
  <id>https://kkzhanga.github.io/</id>
  
  <author>
    <name>kkzhang</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>springBoot之过滤器 vs 拦截器</title>
    <link href="https://kkzhanga.github.io/2020/12/11/spring/filterAndInterceptor/"/>
    <id>https://kkzhanga.github.io/2020/12/11/spring/filterAndInterceptor/</id>
    <published>2020-12-11T08:43:07.000Z</published>
    <updated>2020-12-14T12:18:20.871Z</updated>
    
    <content type="html"><![CDATA[<p>对于过滤器和拦截器只是使用，没有仔细了解二者的区别，这次写个博客好好总结一下。</p><a id="more"></a><h2 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h2><p>过滤器Filter，是在Servlet规范中定义的，是Servlet容器支持的，该接口定义在 javax.servlet包下，主要是在客户端请求(HttpServletRequest)进行预处理，以及对服务器响应(HttpServletResponse)进行后处理</p><h3 id="自定义过滤器"><a href="#自定义过滤器" class="headerlink" title="自定义过滤器"></a>自定义过滤器</h3><details>  <summary>Java</summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebFilter(urlPatterns = &quot;/*&quot;, filterName = &quot;a&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">    <span class="comment">//初始化接口,服务启动的时候加载</span></span><br><span class="line">    System.out.println(<span class="string">&quot;init1执行&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">    <span class="comment">/** 在每个用户的请求进来时这个方法都会被调用，并在Servlet的service方法之前调用(如果我们是开发Servlet项目)，而FilterChain就代表当前的整个请求链，</span></span><br><span class="line"><span class="comment">     * 通过调用 FilterChain.doFilter可以将请求继续传递下去，如果想拦截这个请求，可以不调用FilterChain.doFilter，那么这个请求就直接返回了，</span></span><br><span class="line"><span class="comment">     * 所以Filter是一种责任链设计模式，在spring security就大量使用了过滤器，有一条过滤器链。*/</span></span><br><span class="line">    System.out.println(<span class="string">&quot;doFilter1执行&quot;</span>);</span><br><span class="line">    <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">    filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">    System.out.println(<span class="string">&quot;Filter1 cost=&quot;</span> + (System.currentTimeMillis() - start));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//当Filter对象被销毁时(优雅停服)被调用，注意当Web容器调用这个方法之后，容器会再调用一次doFilter方法</span></span><br><span class="line">    System.out.println(<span class="string">&quot;destroy1执行&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@ServletComponentScan(value = &#123;&quot;com.kk.zhang.filter&quot;&#125;)</span><span class="comment">//指定扫描自定义过滤器所在包</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderApp</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    ConfigurableApplicationContext ctx = SpringApplication.run(OrderApp.class, args);</span><br><span class="line">    <span class="comment">//停服</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    try &#123;</span></span><br><span class="line"><span class="comment">      TimeUnit.SECONDS.sleep(30);</span></span><br><span class="line"><span class="comment">    &#125; catch (InterruptedException e) &#123;</span></span><br><span class="line"><span class="comment">      e.printStackTrace();</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    ctx.close();*/</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></details><p>除了上述自定义过滤器方式，还有一种就是FilterRegistrationBean来完成配置。<br>如果自定义多个过滤器如何排序呢？@WebFilter这个注解并没有指定执行顺序的属性，其执行顺序依赖于Filter的名称，是根据Filter类名（注意不是配置的filter的名字）的字母顺序倒序排列，并且@WebFilter指定的过滤器优先级都高于FilterRegistrationBean配置的过滤器。</p><h2 id="拦截器"><a href="#拦截器" class="headerlink" title="拦截器"></a>拦截器</h2><p>拦截器是Spring提出的概念，它的作用于过滤器类似，可以拦截用户请求并进行相应的处理，它可以进行更加精细的控制。<br>在SpringMVC中，DispatcherServlet捕获每个请求，在到达对应的Controller之前，请求可以被拦截器处理，在拦截器中进行前置处理后，请求最终才到达Controller。</p><h3 id="自定义拦截器"><a href="#自定义拦截器" class="headerlink" title="自定义拦截器"></a>自定义拦截器</h3><details>  <summary>Java</summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">//对客户端发过来的请求进行前置处理，如果方法返回true,继续执行后续操作，如果返回false，执行中断请求处理，请求不会发送到Controller</span></span><br><span class="line">    start = System.currentTimeMillis();</span><br><span class="line">    System.out.println(<span class="string">&quot;preHandle1&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">//在请求进行处理后执行，也就是在Controller方法调用之后处理，当然前提是之前的 preHandle方法返回 true。具体来说，</span></span><br><span class="line">    <span class="comment">// postHandler方法会在DispatcherServlet进行视图返回渲染前被调用，也就是说我们可以在这个方法中对 Controller 处理之后的ModelAndView对象进行操作</span></span><br><span class="line">    System.out.println(<span class="string">&quot;postHandle1 cost=&quot;</span>+(System.currentTimeMillis()-start));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o, Exception e)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">//该方法在整个请求结束之后执行，当然前提依然是 preHandle方法的返回值为 true才行。该方法一般用于资源清理工作</span></span><br><span class="line">    System.out.println(<span class="string">&quot;afterCompletion1&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InterceptorConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//实现多个拦截器，并依次将他们注册进去</span></span><br><span class="line">    registry.addInterceptor(handlerInterceptorA())</span><br><span class="line">        .addPathPatterns(<span class="string">&quot;/**&quot;</span>); <span class="comment">//配置拦截规则</span></span><br><span class="line">    registry.addInterceptor(handlerInterceptorB())</span><br><span class="line">        .addPathPatterns(<span class="string">&quot;/**&quot;</span>); <span class="comment">//配置拦截规则</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> HandlerInterceptor <span class="title">handlerInterceptorA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> AInterceptor();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> HandlerInterceptor <span class="title">handlerInterceptorB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BInterceptor();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details><p>拦截器的顺序跟他们注册时的顺序有关，下图表示了两个拦截器协同工作时的执行顺序：<br><img src="https://i.loli.net/2020/12/14/hcp3HRoPLqbaNxG.png" class="lazyload" data-srcset="https://i.loli.net/2020/12/14/hcp3HRoPLqbaNxG.png" srcset="data:image/png;base64,666" alt="1214_1.jpg"></p><h2 id="执行顺序"><a href="#执行顺序" class="headerlink" title="执行顺序"></a>执行顺序</h2><p>过滤器init -&gt; 过滤器doFilter -&gt; 拦截器preHandle -&gt; aop -&gt; 业务逻辑 -&gt; 拦截器postHandle -&gt; 拦截器afterCompletion -&gt; 过滤器destroy</p><p>测试结果：</p><details>  <summary>Java</summary> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">doFilter1执行</span><br><span class="line">doFilter2执行</span><br><span class="line">preHandle1</span><br><span class="line">preHandle2</span><br><span class="line">业务</span><br><span class="line">postHandle2 cost=<span class="number">1</span></span><br><span class="line">postHandle1 cost=<span class="number">1</span></span><br><span class="line">afterCompletion2</span><br><span class="line">afterCompletion1</span><br><span class="line">Filter2 cost=<span class="number">5</span></span><br><span class="line">Filter1 cost=<span class="number">5</span></span><br></pre></td></tr></table></figure></details><h2 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h2><p>从上面对拦截器与过滤器的描述来看，它俩是非常相似的，都能对客户端发来的请求进行处理，它们的区别如下：</p><ul><li>作用域不同</li></ul><p>过滤器依赖于servlet容器，基于函数回调，对所有请求起作用<br>拦截器依赖于spring容器，基于反射，对action请求起作用</p><ul><li>细粒度的不同</li></ul><p>过滤器的控制比较粗，只能在请求进来时进行处理，对请求和响应进行包装<br>拦截器提供更精细的控制，可以在controller对请求处理之前或之后被调用，也可以在渲染视图呈现给用户之后调用</p><ul><li>中断链执行的难易程度不同</li></ul><p>拦截器可以 preHandle方法内返回 false 进行中断<br>过滤器就比较复杂，需要处理请求和响应对象来引发中断，需要额外的动作，比如将用户重定向到错误页面</p><h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><ul><li><p>过滤器的应用：<br>字符编码转换，敏感词过滤、登陆权限验证、资源访问权限等</p></li><li><p>拦截器的应用：<br>AOP、需要有一些业务逻辑（需要注入Bean等）</p></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;对于过滤器和拦截器只是使用，没有仔细了解二者的区别，这次写个博客好好总结一下。&lt;/p&gt;</summary>
    
    
    
    <category term="springBoot" scheme="https://kkzhanga.github.io/categories/springBoot/"/>
    
    
    <category term="springBoot" scheme="https://kkzhanga.github.io/tags/springBoot/"/>
    
    <category term="filter" scheme="https://kkzhanga.github.io/tags/filter/"/>
    
    <category term="interceptor" scheme="https://kkzhanga.github.io/tags/interceptor/"/>
    
  </entry>
  
  <entry>
    <title>从零搭建sprinCloud框架（三）</title>
    <link href="https://kkzhanga.github.io/2020/11/27/springCloud/buildSprinCloud_3/"/>
    <id>https://kkzhanga.github.io/2020/11/27/springCloud/buildSprinCloud_3/</id>
    <published>2020-11-27T06:16:20.000Z</published>
    <updated>2020-12-10T09:44:58.124Z</updated>
    
    
    
    
    
  </entry>
  
  <entry>
    <title>从零搭建sprinCloud框架（二）</title>
    <link href="https://kkzhanga.github.io/2020/11/26/springCloud/buildSprinCloud_2/"/>
    <id>https://kkzhanga.github.io/2020/11/26/springCloud/buildSprinCloud_2/</id>
    <published>2020-11-26T06:16:20.000Z</published>
    <updated>2020-12-10T10:40:47.746Z</updated>
    
    <content type="html"><![CDATA[<h1 id="整合gateway"><a href="#整合gateway" class="headerlink" title="整合gateway"></a>整合gateway</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>SpringCloud Gateway成为SpringCloud的重要组件是为了提到替代Netflix Zuul(1.x版本基于过滤器，阻塞IO，不支持长连接，2.x版本一直跳票，2019年5月，开源了支持异步调用模式的Zuul 2.0版本)</p><a id="more"></a><h2 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h2><ul><li>动态路由</li><li>限流</li><li>跨域</li><li>鉴权，黑白名单机制</li><li>日志记录</li></ul><h3 id="动态路由"><a href="#动态路由" class="headerlink" title="动态路由"></a>动态路由</h3><h4 id="Gateway与Eureka整合"><a href="#Gateway与Eureka整合" class="headerlink" title="Gateway与Eureka整合"></a>Gateway与Eureka整合</h4><p>原理：网关根据serviceId自动从注册中心获取服务地址并转发请求</p><h5 id="新建eureka微服务："><a href="#新建eureka微服务：" class="headerlink" title="新建eureka微服务："></a>新建eureka微服务：</h5><details>  <summary>YML</summary><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#当前服务名称</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-service</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#端口,路径</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">10002</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span> <span class="comment">#自身 不在向eureka注册</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span> <span class="comment">#启动时禁用client的注册</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:10002/eureka</span></span><br></pre></td></tr></table></figure></details><details>  <summary>POM</summary><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">   &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">   &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-server&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure></details><details>  <summary>Java</summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaApp</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">       SpringApplication.run(EurekaApp.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details><h5 id="新建gateway微服务："><a href="#新建gateway微服务：" class="headerlink" title="新建gateway微服务："></a>新建gateway微服务：</h5><details>  <summary>YML</summary><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#当前服务名称</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway-server</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">discovery:</span>                         <span class="comment"># 是否与服务发现组件进行结合，通过 serviceId 转发到具体服务实例。</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span>                  <span class="comment"># 是否开启基于服务发现的路由规则</span></span><br><span class="line">          <span class="attr">lower-case-service-id:</span> <span class="literal">true</span>    <span class="comment"># 是否将服务名称转小写</span></span><br><span class="line">      <span class="attr">routes:</span>                      <span class="comment"># 路由规则</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">order-service</span>           <span class="comment"># 路由 ID，唯一</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">lb://order-service</span>   <span class="comment"># 目标 URI，路由到微服务的地址</span></span><br><span class="line">        <span class="attr">predicates:</span>                   <span class="comment"># 断言（判断条件）</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=/order/**</span>          <span class="comment"># 匹配对应 URL 的请求，将匹配到的请求追加在目标 URI 之后</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#端口,路径</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">11111</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 Eureka Server 注册中心</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:10002/eureka</span></span><br></pre></td></tr></table></figure></details><details>  <summary>XML</summary><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></details><details>  <summary>Java</summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayApp</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        SpringApplication.run(GatewayApp.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details><h5 id="新建order微服务："><a href="#新建order微服务：" class="headerlink" title="新建order微服务："></a>新建order微服务：</h5><p>  根据上面示例创建两个端口不同，名称一致的微服务提供者，模拟集群多示例（略）。</p><h5 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h5><p>  <img src="https://i.loli.net/2020/11/27/8cILNv23TKGpHj9.png" class="lazyload" data-srcset="https://i.loli.net/2020/11/27/8cILNv23TKGpHj9.png" srcset="data:image/png;base64,666" alt="20201127_1.jpg"><br>  打开eureka控制台我们就可以看到order已经有了两个实例，通过多次点击查询，返回不同实例值。证明达到了负载均衡的效果(eureka集成了ribbon，默认使用的负载均衡策略是轮询，待后续研究)</p><h3 id="限流"><a href="#限流" class="headerlink" title="限流"></a>限流</h3><h4 id="限流背景"><a href="#限流背景" class="headerlink" title="限流背景"></a>限流背景</h4><ul><li>业务发展迅速</li><li>恶意请求，瞬间并发</li></ul><h4 id="限流规则"><a href="#限流规则" class="headerlink" title="限流规则"></a>限流规则</h4><ul><li>依赖：<details>  <summary>POM</summary></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-data-redis-reactive&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure></details><ul><li>限流参数：<details>  <summary>YML</summary></li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway-server</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">47.102</span><span class="number">.104</span><span class="number">.200</span>  <span class="comment"># Redis服务器地址</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span>            <span class="comment"># Redis服务器端口</span></span><br><span class="line">    <span class="comment">#password: admin        # Redis服务器密码</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">discovery:</span>                         <span class="comment"># 是否与服务发现组件进行结合，通过 serviceId 转发到具体服务实例。</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span>                  <span class="comment"># 是否开启基于服务发现的路由规则</span></span><br><span class="line">          <span class="attr">lower-case-service-id:</span> <span class="literal">true</span>    <span class="comment"># 是否将服务名称转小写</span></span><br><span class="line">      <span class="attr">routes:</span>                      <span class="comment"># 路由规则</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">order-service</span>           <span class="comment"># 路由 ID，唯一</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">lb://order-service</span>   <span class="comment"># 目标 URI，路由到微服务的地址</span></span><br><span class="line">        <span class="attr">predicates:</span>                   <span class="comment"># 断言（判断条件）</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=/order/**</span>          <span class="comment"># 匹配对应 URL 的请求，将匹配到的请求追加在目标 URI 之后</span></span><br><span class="line">        <span class="attr">filters:</span>                       <span class="comment"># 网关过滤器</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">RequestRateLimiter</span>      <span class="comment"># 限流过滤器</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="attr">redis-rate-limiter.replenishRate:</span> <span class="number">1</span> <span class="comment"># 令牌桶每秒填充速率</span></span><br><span class="line">            <span class="attr">redis-rate-limiter.burstCapacity:</span> <span class="number">2</span> <span class="comment"># 令牌桶总容量</span></span><br><span class="line">            <span class="attr">key-resolver:</span> <span class="string">&quot;#&#123;@pathKeyResolver&#125;&quot;</span> <span class="comment"># 使用 SpEL 表达式按名称引用 bean</span></span><br></pre></td></tr></table></figure></details><ul><li>filter名称必须是RequestRateLimiter</li><li>redis-rate-limiter.replenishRate：允许用户每秒处理多少个请求</li><li>redis-rate-limiter.burstCapacity：令牌桶的容量，允许在一秒钟内完成的最大请求数</li><li>key-resolver：使用SpEL按名称引用bean</li></ul><h5 id="IP限流"><a href="#IP限流" class="headerlink" title="IP限流"></a>IP限流</h5><details>  <summary>Java</summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> KeyResolver <span class="title">ipKeyResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> exchange -&gt; Mono.just(exchange.getRequest().getRemoteAddress().getHostName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details><h5 id="接口限流"><a href="#接口限流" class="headerlink" title="接口限流"></a>接口限流</h5><details>  <summary>Java</summary><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> KeyResolver <span class="title">pathKeyResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> exchange -&gt; Mono.just(exchange.getRequest().getURI().getPath());</span><br><span class="line">  &#125;</span><br><span class="line">  &lt;details&gt;  </span><br><span class="line">&lt;summary&gt;Java&lt;/summary&gt;</span><br></pre></td></tr></table></figure></details><h5 id="参数限流"><a href="#参数限流" class="headerlink" title="参数限流"></a>参数限流</h5><details>  <summary>Java</summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> KeyResolver <span class="title">parameterKeyResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> exchange -&gt; Mono.just(exchange.getRequest().getQueryParams().getFirst(<span class="string">&quot;userId&quot;</span>));</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></details><h4 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h4><p>浏览器中对此点击进行接口测试，Redis中会有对应的数据：<br><img src="https://i.loli.net/2020/12/01/efbwAHg5JI79L4V.png" class="lazyload" data-srcset="https://i.loli.net/2020/12/01/efbwAHg5JI79L4V.png" srcset="data:image/png;base64,666" alt="1201_1.jpg"></p><ul><li>timestamp:存储的是当前时间的秒数，也就是System.currentTimeMillis() / 1000或者Instant.now().getEpochSecond()</li><li>tokens:存储的是当前这秒钟的对应的可用的令牌数量</li></ul><h4 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h4><p>限流是根据每秒处理数，redis中数据存留的时间只有一秒钟，如果你不快点看redis中是否有数据的话，就看不到了</p><h3 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h3><p>Spring Cloud Gateway 根据作用范围划分为 GatewayFilter(局部) 和 GlobalFilter(全局)，二者区别如下：</p><ul><li>GatewayFilter：局部过滤器，需要通过 spring.cloud.routes.filters 配置在具体路由下，只作用在当前路由上或通过 spring.cloud.default-filters 配置在全局，作用在所有路由上。</li><li>GlobalFilter：全局过滤器，不需要在配置文件中配置，作用在所有的路由上，最终通过 GatewayFilterAdapter 包装成 GatewayFilterChain 可识别的过滤器，它为请求业务以及路由的 URI 转换为真实业务服务请求地址的核心过滤器，不需要配置系统初始化时加载，并作用在每个路由上。</li></ul><h4 id="局部过滤器"><a href="#局部过滤器" class="headerlink" title="局部过滤器"></a>局部过滤器</h4><p>网关过滤器用于拦截并链式处理 Web 请求，可以实现横切与应用无关的需求，比如：安全、访问超时的设置等。修改传入的 HTTP 请求或传出 HTTP 响应。Spring Cloud Gateway 包含许多内置的网关过滤器工厂一共有 22 个，包括头部过滤器、 路径类过滤器、Hystrix 过滤器和重写请求 URL 的过滤器， 还有参数和状态码等其他类型的过滤器。根据过滤器工厂的用途来划分，可以分为以下几种：Header、Parameter、Path、Body、Status、Session、Redirect、Retry、RateLimiter 和 Hystrix。</p><p>我们举个例子说明如何使用</p><h5 id="Path路径过滤器"><a href="#Path路径过滤器" class="headerlink" title="Path路径过滤器"></a>Path路径过滤器</h5><ul><li>StripPrefixGatewayFilterFactory</li></ul><details>  <summary>YML</summary><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway-server</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">47.102</span><span class="number">.104</span><span class="number">.200</span>  <span class="comment"># Redis服务器地址</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span>            <span class="comment"># Redis服务器端口</span></span><br><span class="line">    <span class="comment">#password: admin        # Redis服务器密码</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">discovery:</span>                         <span class="comment"># 是否与服务发现组件进行结合，通过 serviceId 转发到具体服务实例。</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span>                  <span class="comment"># 是否开启基于服务发现的路由规则</span></span><br><span class="line">          <span class="attr">lower-case-service-id:</span> <span class="literal">true</span>    <span class="comment"># 是否将服务名称转小写</span></span><br><span class="line">      <span class="attr">routes:</span>                      <span class="comment"># 路由规则</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">order-service</span>           <span class="comment"># 路由 ID，唯一</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">lb://order-service</span>   <span class="comment"># 目标 URI，路由到微服务的地址</span></span><br><span class="line">        <span class="attr">predicates:</span>                   <span class="comment"># 断言（判断条件）</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=/order/**</span>          <span class="comment"># 匹配对应 URL 的请求，将匹配到的请求追加在目标 URI 之后</span></span><br><span class="line">        <span class="attr">filters:</span>                       <span class="comment"># 网关过滤器</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">StripPrefix=1</span>                  <span class="comment"># 将 /api/order/1 重写为 /order/1</span></span><br></pre></td></tr></table></figure></details><h5 id="自定义局部过滤器"><a href="#自定义局部过滤器" class="headerlink" title="自定义局部过滤器"></a>自定义局部过滤器</h5><p>1、继承GatewayFilter，实现后使用java方式配置路由；</p><p>2、继承AbstractGatewayFilterFactory，注入为bean即可（推荐）</p><ul><li>自定义局部过滤器，并且加入到过滤器工厂，注册到spring容器中</li></ul><details>  <summary>Java</summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PartGatewayFilter</span> <span class="keyword">implements</span> <span class="title">GatewayFilter</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;自定义局部过滤器执行。。。&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 过滤器执行顺序，数值越小，优先级越高</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PartGatewayFilterFactory</span> <span class="keyword">extends</span> <span class="title">AbstractGatewayFilterFactory</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> GatewayFilter <span class="title">apply</span><span class="params">(Object config)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PartGatewayFilter();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details><details>  <summary>YML</summary><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway-server</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">47.102</span><span class="number">.104</span><span class="number">.200</span>  <span class="comment"># Redis服务器地址</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span>            <span class="comment"># Redis服务器端口</span></span><br><span class="line">    <span class="comment">#password: admin        # Redis服务器密码</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">discovery:</span>                         <span class="comment"># 是否与服务发现组件进行结合，通过 serviceId 转发到具体服务实例。</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span>                  <span class="comment"># 是否开启基于服务发现的路由规则</span></span><br><span class="line">          <span class="attr">lower-case-service-id:</span> <span class="literal">true</span>    <span class="comment"># 是否将服务名称转小写</span></span><br><span class="line">      <span class="attr">routes:</span>                      <span class="comment"># 路由规则</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">order-service</span>           <span class="comment"># 路由 ID，唯一</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">lb://order-service</span>   <span class="comment"># 目标 URI，路由到微服务的地址</span></span><br><span class="line">        <span class="attr">predicates:</span>                   <span class="comment"># 断言（判断条件）</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=/order/**</span>          <span class="comment"># 匹配对应 URL 的请求，将匹配到的请求追加在目标 URI 之后</span></span><br><span class="line">        <span class="attr">filters:</span>                       <span class="comment"># 网关过滤器</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">StripPrefix=1</span>                  <span class="comment"># 将 /api/order/1 重写为 /order/1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Part</span>                           <span class="comment">#自定义局部过滤器(配置名称取GatewayFilter前字符串)</span></span><br></pre></td></tr></table></figure></details><h5 id="自定义局部过滤器-指定IP访问"><a href="#自定义局部过滤器-指定IP访问" class="headerlink" title="自定义局部过滤器  - 指定IP访问"></a>自定义局部过滤器  - 指定IP访问</h5><p>我们的需求是如果在配置文件配置了一个IP，那么该ip就可以访问，其它IP通通不能访问。如果不使用该过滤器，那么所有IP都可以访问服务。</p><p>这里我们看到上面的PartGatewayFilter和PartGatewayFilterFactory代码本来就是为了同一个过滤器规则编写的两个类，如果过滤器规则很多，那么类文件就很多，其实这两个类可以合并成一个类：</p><details>  <summary>Java</summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Order(Ordered.LOWEST_PRECEDENCE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IPForbidGatewayFilterFactory</span> <span class="keyword">extends</span> <span class="title">AbstractGatewayFilterFactory</span>&lt;<span class="title">IPForbidGatewayFilterFactory</span>.<span class="title">Config</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">IPForbidGatewayFilterFactory</span><span class="params">()</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(Config.class);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">shortcutFieldOrder</span><span class="params">()</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="comment">//集合中数据对应Config对象中属性,yml文件中IPForbid带的参数会映射上去,多个参数以逗号隔开</span></span><br><span class="line">    <span class="keyword">return</span> Arrays.asList(<span class="string">&quot;ip&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> GatewayFilter <span class="title">apply</span><span class="params">(Config config)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (exchange, chain) -&gt; &#123;</span><br><span class="line">      String ip = exchange.getRequest().getRemoteAddress().getAddress().getHostAddress();</span><br><span class="line">      <span class="keyword">if</span> (config.ip.equals(ip))</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">      &#125;</span><br><span class="line">      exchange.getResponse().setStatusCode(HttpStatus.FORBIDDEN);</span><br><span class="line">      <span class="keyword">return</span> exchange.getResponse().setComplete();</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Data</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Config</span></span></span><br><span class="line"><span class="class">  </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String ip;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details><details>  <summary>YML</summary><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filters:</span>                       <span class="comment"># 网关过滤器</span></span><br><span class="line">       <span class="comment"># - StripPrefix=1                  # 将 /api/order/1 重写为 /order/1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Part</span>                           <span class="comment">#自定义局部过滤器(配置名称取GatewayFilter前字符串)</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">IPForbid=0:0:0:0:0:0:0:1</span></span><br></pre></td></tr></table></figure></details><h4 id="全局过滤器"><a href="#全局过滤器" class="headerlink" title="全局过滤器"></a>全局过滤器</h4><p>实现 GlobalFilter 和 Ordered，重写相关方法，加入到spring容器管理即可，无需配置，全局过滤器对所有的路由都有效。</p><h5 id="自定义全局过滤器"><a href="#自定义全局过滤器" class="headerlink" title="自定义全局过滤器"></a>自定义全局过滤器</h5><ul><li>接口</li></ul><details>  <summary>Java</summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WholeGlobalFilter</span> <span class="keyword">implements</span> <span class="title">GlobalFilter</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;自定义全局过滤器执行。。。&quot;</span>);</span><br><span class="line">    <span class="comment">//调用请求之前统计时间</span></span><br><span class="line">    Long startTime = System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">return</span> chain.filter(exchange).then().then(Mono.fromRunnable(() -&gt; &#123;</span><br><span class="line">      <span class="comment">//调用请求之后统计时间</span></span><br><span class="line">      Long endTime = System.currentTimeMillis();</span><br><span class="line">      System.out.println(</span><br><span class="line">          exchange.getRequest().getURI().getRawPath() + <span class="string">&quot;, 请求耗时 : &quot;</span> + (endTime - startTime) + <span class="string">&quot;ms&quot;</span>);</span><br><span class="line">    &#125;)); <span class="comment">// 继续向下执行</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details><ul><li>配置</li></ul><details>  <summary>Java</summary><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WholeGlobalFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="meta">@Order(1)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> GlobalFilter <span class="title">elapsedGlobalFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (exchange, chain) -&gt; &#123;</span><br><span class="line">      <span class="comment">//调用请求之前统计时间</span></span><br><span class="line">      Long startTime = System.currentTimeMillis();</span><br><span class="line">      <span class="keyword">return</span> chain.filter(exchange).then().then(Mono.fromRunnable(() -&gt; &#123;</span><br><span class="line">        <span class="comment">//调用请求之后统计时间</span></span><br><span class="line">        Long endTime = System.currentTimeMillis();</span><br><span class="line">        System.out.println(</span><br><span class="line">            exchange.getRequest().getURI().getRawPath() + <span class="string">&quot;, 请求耗时 : &quot;</span> + (endTime - startTime) + <span class="string">&quot;ms&quot;</span>);</span><br><span class="line">      &#125;));</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;整合gateway&quot;&gt;&lt;a href=&quot;#整合gateway&quot; class=&quot;headerlink&quot; title=&quot;整合gateway&quot;&gt;&lt;/a&gt;整合gateway&lt;/h1&gt;&lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;p&gt;SpringCloud Gateway成为SpringCloud的重要组件是为了提到替代Netflix Zuul(1.x版本基于过滤器，阻塞IO，不支持长连接，2.x版本一直跳票，2019年5月，开源了支持异步调用模式的Zuul 2.0版本)&lt;/p&gt;</summary>
    
    
    
    <category term="SpringCloud" scheme="https://kkzhanga.github.io/categories/SpringCloud/"/>
    
    
  </entry>
  
  <entry>
    <title>从零搭建sprinCloud框架（一）</title>
    <link href="https://kkzhanga.github.io/2020/11/19/springCloud/buildSprinCloud_1/"/>
    <id>https://kkzhanga.github.io/2020/11/19/springCloud/buildSprinCloud_1/</id>
    <published>2020-11-19T08:43:07.000Z</published>
    <updated>2020-12-10T08:16:04.115Z</updated>
    
    <content type="html"><![CDATA[<h1 id="搭建工程基础框架"><a href="#搭建工程基础框架" class="headerlink" title="搭建工程基础框架"></a>搭建工程基础框架</h1><h2 id="项目父工程配置"><a href="#项目父工程配置" class="headerlink" title="项目父工程配置"></a>项目父工程配置</h2><h3 id="Idea创建工程："><a href="#Idea创建工程：" class="headerlink" title="Idea创建工程："></a>Idea创建工程：</h3><ol><li><p>File -&gt; New -&gt; Project<br><img src="https://i.loli.net/2020/11/26/NBF8rXovSbeYOWG.png" class="lazyload" data-srcset="https://i.loli.net/2020/11/26/NBF8rXovSbeYOWG.png" srcset="data:image/png;base64,666" alt="1606358078.jpg"></p><a id="more"></a></li><li><p>Empty Project -&gt;Next<br><img src="https://i.loli.net/2020/11/19/zK9nLFk1MbWvsNQ.png" class="lazyload" data-srcset="https://i.loli.net/2020/11/19/zK9nLFk1MbWvsNQ.png" srcset="data:image/png;base64,666" alt="20201119_1.jpg"></p></li><li><p>项目命名 -&gt; 项目位置-&gt; Finish<br><img src="https://i.loli.net/2020/11/19/h9vF4OrxuwPidCp.png" class="lazyload" data-srcset="https://i.loli.net/2020/11/19/h9vF4OrxuwPidCp.png" srcset="data:image/png;base64,666" alt="20201119_2.jpg"></p></li><li><p>选择打开新窗口<br><img src="https://i.loli.net/2020/11/19/SorBZD7w5UJkfbm.png" class="lazyload" data-srcset="https://i.loli.net/2020/11/19/SorBZD7w5UJkfbm.png" srcset="data:image/png;base64,666" alt="20201119_3.jpg"></p></li></ol><h2 id="项目子工程配置"><a href="#项目子工程配置" class="headerlink" title="项目子工程配置"></a>项目子工程配置</h2><h3 id="配置Maven"><a href="#配置Maven" class="headerlink" title="配置Maven"></a>配置Maven</h3><ol><li>File -&gt; Settings -&gt; OK<br><img src="https://i.loli.net/2020/11/19/oO2StVpT7iPZkYr.png" class="lazyload" data-srcset="https://i.loli.net/2020/11/19/oO2StVpT7iPZkYr.png" srcset="data:image/png;base64,666" alt="20201119_5.jpg"></li></ol><h3 id="新建Module文件"><a href="#新建Module文件" class="headerlink" title="新建Module文件"></a>新建Module文件</h3><ol><li><p>项目上右击 -&gt; New -&gt; Module<br><img src="https://i.loli.net/2020/11/19/HwXy316SuYQ7L4E.png" class="lazyload" data-srcset="https://i.loli.net/2020/11/19/HwXy316SuYQ7L4E.png" srcset="data:image/png;base64,666" alt="20201119_4.jpg"></p></li><li><p>选择java -&gt; Next<br><img src="https://i.loli.net/2020/11/19/BH5sdGnhqiEFDUv.png" class="lazyload" data-srcset="https://i.loli.net/2020/11/19/BH5sdGnhqiEFDUv.png" srcset="data:image/png;base64,666" alt="20201119_6.jpg"></p></li><li><p>设置中台模块名称<br><img src="https://i.loli.net/2020/11/19/jcRfaSLT37sK956.png" class="lazyload" data-srcset="https://i.loli.net/2020/11/19/jcRfaSLT37sK956.png" srcset="data:image/png;base64,666" alt="20201119_7.jpg"></p></li><li><p>其他同级模块新建同理，比如前台，docs，sql等，最终呈现如图所示：<br><img src="https://i.loli.net/2020/11/19/FKQ7DijYWXytxdr.png" class="lazyload" data-srcset="https://i.loli.net/2020/11/19/FKQ7DijYWXytxdr.png" srcset="data:image/png;base64,666" alt="20201119_8.jpg"></p></li></ol><h3 id="新建maven项目"><a href="#新建maven项目" class="headerlink" title="新建maven项目"></a>新建maven项目</h3><ol><li><p>项目上右击(如middle) -&gt; New -&gt; Module -&gt; Maven -&gt; quickstart -&gt;Next<br><img src="https://i.loli.net/2020/11/19/Vtwfn53o6eKFjAp.png" class="lazyload" data-srcset="https://i.loli.net/2020/11/19/Vtwfn53o6eKFjAp.png" srcset="data:image/png;base64,666" alt="20201119_9.jpg"></p></li><li><p>设置ArtifactId，groupId为组织名，一般为公司网址反写 -&gt; Next<br><img src="https://i.loli.net/2020/11/19/7UchfKAoGlgwX4L.png" class="lazyload" data-srcset="https://i.loli.net/2020/11/19/7UchfKAoGlgwX4L.png" srcset="data:image/png;base64,666" alt="20201119_10.jpg"></p></li><li><p>设置工程名称(在根目录下新加同名子文件夹) -&gt; Finish<br><img src="https://i.loli.net/2020/11/19/czsI92GtQM6D8dS.png" class="lazyload" data-srcset="https://i.loli.net/2020/11/19/czsI92GtQM6D8dS.png" srcset="data:image/png;base64,666" alt="20201119_11.jpg"></p></li><li><p>创建resources文件夹:</p><ul><li><p>右击main -&gt; New -&gt; Directory<br><img src="https://i.loli.net/2020/11/19/ALsRBygK2H7Wcnx.png" class="lazyload" data-srcset="https://i.loli.net/2020/11/19/ALsRBygK2H7Wcnx.png" srcset="data:image/png;base64,666" alt="20201119_12.jpg"></p></li><li><p>右击resources, 变成有黄色的横杠,作为资源根目录<br><img src="https://i.loli.net/2020/11/19/OzhqiK2DVgTyN3F.png" class="lazyload" data-srcset="https://i.loli.net/2020/11/19/OzhqiK2DVgTyN3F.png" srcset="data:image/png;base64,666" alt="20201119_13.jpg"></p></li></ul></li></ol>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;搭建工程基础框架&quot;&gt;&lt;a href=&quot;#搭建工程基础框架&quot; class=&quot;headerlink&quot; title=&quot;搭建工程基础框架&quot;&gt;&lt;/a&gt;搭建工程基础框架&lt;/h1&gt;&lt;h2 id=&quot;项目父工程配置&quot;&gt;&lt;a href=&quot;#项目父工程配置&quot; class=&quot;headerlink&quot; title=&quot;项目父工程配置&quot;&gt;&lt;/a&gt;项目父工程配置&lt;/h2&gt;&lt;h3 id=&quot;Idea创建工程：&quot;&gt;&lt;a href=&quot;#Idea创建工程：&quot; class=&quot;headerlink&quot; title=&quot;Idea创建工程：&quot;&gt;&lt;/a&gt;Idea创建工程：&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;&lt;p&gt;File -&amp;gt; New -&amp;gt; Project&lt;br&gt;&lt;img src=&quot;https://i.loli.net/2020/11/26/NBF8rXovSbeYOWG.png&quot; alt=&quot;1606358078.jpg&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="SpringCloud" scheme="https://kkzhanga.github.io/categories/SpringCloud/"/>
    
    
    <category term="SpringCloud" scheme="https://kkzhanga.github.io/tags/SpringCloud/"/>
    
    <category term="maven" scheme="https://kkzhanga.github.io/tags/maven/"/>
    
    <category term="idea" scheme="https://kkzhanga.github.io/tags/idea/"/>
    
  </entry>
  
</feed>
